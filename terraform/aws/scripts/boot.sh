#!/bin/bash

yum update
yum install -y yum-plugin-security
yum --security update -y

echo "Setting NTP"
yum erase 'ntp*'
yum install -y chrony
echo "server 169.254.169.123 prefer iburst minpoll 4 maxpoll 4" > /etc/chrony.conf
service chronyd restart
chkconfig chronyd on

echo "Setting environment"
yum install -y docker
yum install -y wireshark
curl -s https://s3.amazonaws.com/download.draios.com/stable/install-sysdig | bash
service docker start
groupadd docker
usermod -aG docker $USER

echo "Setting ossmalware"
yum install -y golang git
export GOPATH=/usr/bin
export GOCACHE=/root/.cache/go-build
git clone https://github.com/jordan-wright/ossmalware.git /usr/local/ossmalware
cd /usr/local/ossmalware
docker pull python:3-alpine
docker pull ruby:3.2-rc-alpine
docker build -t tcpdump -f tcpdump.Dockerfile .
go build
export AWS_DEFAULT_REGION=us-east-1
echo "${ossmalware_queue_url}"
echo "${ossmalware_upload_bucket_url}"
OSSMALWARE_QUEUE_URL=${ossmalware_queue_url} OSSMALWARE_UPLOAD_BUCKET_URL=${ossmalware_upload_bucket_url} ./ossmalware
echo "Complete ossmalware boot"