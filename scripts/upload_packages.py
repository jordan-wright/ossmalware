import boto3
import os
import json
import hashlib
import sys
"""
Uploads a list of package names from a local file to SQS so they can be
processed
"""

MAX_BATCH_SIZE = 10

package_type = sys.argv[1]
package_file = sys.argv[2]
queue_region = sys.argv[3]
queue_name = sys.argv[4]

client = boto3.client('sqs', region_name=queue_region)

response = client.get_queue_url(
    QueueName=queue_name, )

queue_url = response['QueueUrl']

with open(package_file, 'r') as packages:
    batch = []
    for package in packages.readlines():
        package = package.strip()
        batch.append({
            'Id':
            hashlib.sha1(package.encode('utf-8')).hexdigest(),
            'MessageBody':
            json.dumps({
                'type': package_type,
                'version': '',
                'name': package
            })
        })
        if len(batch) == 10:
            response = client.send_message_batch(QueueUrl=queue_url,
                                                 Entries=batch)
            print(response)
            if len(response.get('Successful')) == len(batch):
                print('[*] Uploaded {} ... {}'.format(batch[0], batch[-1]))
            else:
                for failure in response.get('Failed'):
                    print('[!] Failed to upload {}: {}'.format(
                        failure.get('Id'), failure.get('Message')))
            batch = []
    if batch != []:
        response = client.send_message_batch(QueueUrl=queue_url,Entries=batch)
        print(response)
        if len(response.get('Successful')) == len(batch):
            print('[*] Uploaded {} ... {}'.format(batch[0], batch[-1]))
        else:
            for failure in response.get('Failed'):
                print('[!] Failed to upload {}: {}'.format(
                    failure.get('Id'), failure.get('Message')))
        batch = []
