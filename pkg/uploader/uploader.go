package uploader

import (
	"context"
	"fmt"
	"io"
	"log"
	"os"
	"path/filepath"

	"github.com/jordan-wright/ossmalware/pkg/library"
	"gocloud.dev/blob"
	_ "gocloud.dev/blob/gcsblob"
	_ "gocloud.dev/blob/s3blob"
)

type BlobUploader struct {
	bucket *blob.Bucket
	url    string
}

func NewBlobUploader(ctx context.Context, url string) (*BlobUploader, error) {
	bucket, err := blob.OpenBucket(ctx, url)
	if err != nil {
		return nil, err
	}
	return &BlobUploader{
		bucket: bucket,
		url:    url,
	}, nil
}

func (up *BlobUploader) Upload(output library.Output) error {
	keyRoot := filepath.Join(output.Package.Type, output.Package.ID())
	for _, fn := range output.Files {
		key := filepath.Join(keyRoot, filepath.Base(fn))

		log.Printf("uploading %s to %s/%s", fn, up.url, key)
		f, err := os.Open(fn)
		if err != nil {
			return err
		}
		defer os.Remove(fn)
		w, err := up.bucket.NewWriter(context.Background(), key, nil)
		if err != nil {
			return err
		}
		if _, err := io.Copy(w, f); err != nil {
			return fmt.Errorf("error uploading to s3: %w", err)
		}
		w.Close()
	}
	return nil
}
